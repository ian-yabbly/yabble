<?xml version='1.0' encoding='utf-8'?>

<beans
    xmlns='http://www.springframework.org/schema/beans'
    xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
    xmlns:c='http://www.springframework.org/schema/c'
    xmlns:p='http://www.springframework.org/schema/p'
    xsi:schemaLocation='
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.1.xsd'
        >

  <bean
      class='org.springframework.beans.factory.config.PropertyPlaceholderConfigurer'
      p:system-properties-mode-name='SYSTEM_PROPERTIES_MODE_OVERRIDE'
      p:ignore-unresolvable-placeholders='true'
      p:ignore-resource-not-found='true'
      >
    <property name='locations'>
      <list>
        <value>classpath:web.properties</value>
        <value>file://${app.home}/etc/override.properties</value>
        <value>file://${app.home}/etc/local.properties</value>
      </list>
    </property>
  </bean>

  <bean
      id='web.velocity-template'
      class='me.yabble.web.template.VelocityTemplate'
      c:encoding='${app.encoding}'
      c:do-less-in-browser='${web.less.do-in-browser}'
      >
    <constructor-arg>
      <props>
        <prop key='runtime.references.strict'>true</prop>
        <prop key='input.encoding'>${app.encoding}</prop>
        <prop key='output.encoding'>${app.encoding}</prop>

        <prop key='resource.loader'>file</prop>
        <prop key='file.resource.loader.class'>org.apache.velocity.runtime.resource.loader.FileResourceLoader</prop>
        <prop key='file.resource.loader.path'>${web.template.base-path}</prop>
        <prop key='file.resource.loader.cache'>true</prop>
        <prop key='file.resource.loader.modificationCheckInterval'>2</prop> <!-- seconds -->

        <prop key='velocimacro.library'>lib/macros.vm</prop>
        <prop key='velocimacro.arguments.strict'>true</prop>
      </props>
    </constructor-arg>

    <constructor-arg>
      <map>
        <entry key='__contextPath' value='${web.context-path}'/>
        <entry key='__versionPathPart' value='v-${app.version-hash}'/>
      </map>
    </constructor-arg>
  </bean>

  <bean
      id='web.session-service'
      class='me.yabble.web.service.SessionService'
      c:redis-client-ref='common.redis-client'
      c:session-cookie-name='${web.session.cookie-name}'
      c:session-cookie-domain='${web.session.cookie-domain}'
      />

  <bean
      class='me.yabble.web.server.Server'
      c:router-ref='web.router'
      c:port='${web.port}'
      c:context-path='${web.context-path}'
      c:session-cookie-name='${web.session.cookie-name}'
      />

  <bean
      id='web.router'
      class='me.yabble.web.server.Router'
      >
    <constructor-arg>
      <list>
        <ref bean='web.static-handler'/>
        <ref bean='web.index-handler'/>
        <ref bean='web.new-ylist-handler'/>
        <ref bean='web.ylist-handler'/>        
      </list>
    </constructor-arg>
  </bean>

  <bean
      id='web.static-handler'
      class='me.yabble.web.server.StaticHandler'
      c:user-service-ref='service.user-service'
      c:session-service-ref='web.session-service'
      c:static-base-resource-path='${web.static.base-resource-path}'
      c:encoding='${app.encoding}'
      />

  <bean
      id='web.image-handler'
      class='me.yabble.web.server.ImageHandler'
      c:user-service-ref='service.user-service'
      c:session-service-ref='web.session-service'
      c:encoding='${app.encoding}'
      c:image-service-ref='service.image-service'
      />

  <bean
      id='web.index-handler'
      class='me.yabble.web.server.IndexHandler'
      c:user-service-ref='service.user-service'
      c:session-service-ref='web.session-service'
      c:template-ref='web.velocity-template'
      c:encoding='${app.encoding}'
      />

  <bean
      id='web.new-ylist-handler'
      class='me.yabble.web.server.NewYListHandler'
      c:user-service-ref='service.user-service'
      c:session-service-ref='web.session-service'
      c:template-ref='web.velocity-template'
      c:encoding='${app.encoding}'
      c:ylist-service-ref='service.ylist-service'
      />
      
  <bean
      id='web.ylist-handler'
      class='me.yabble.web.server.YListHandler'
      c:user-service-ref='service.user-service'
      c:session-service-ref='web.session-service'
      c:template-ref='web.velocity-template'
      c:encoding='${app.encoding}'
      c:ylist-service-ref='service.ylist-service'
      />

</beans>
